var express=require("express"),maindb=require("../service/DBService.js"),User=require("../service/user.js"),jwt=require("jsonwebtoken"),ObjectID=require("mongodb").ObjectID,jwtSecret="kjwdjs65$ikksop0982shj",assert=require("assert"),multer=require("multer"),router=express.Router();router.post("/login",function(e,n){var r=e.body.username,o=e.body.password;maindb(function(e){login(e,r,o,function(e){n.send(e)})})}),router.post("/checkUsr",function(e,n){maindb(function(e){e.collection("users").find().toArray(function(e,r){null===r||0===r.length?defaultUser(function(e,r){n.send("wow")}):n.send("wow")})})}),router.get("/querylist",function(e,n){maindb(function(e){e.collection("query").find().toArray(function(e,r){n.send(r)})})}),router.get("/query/:id",function(e,n){var r=new ObjectID(e.params.id);maindb(function(e){e.collection("query").findOne({_id:r},function(e,r){n.send(r)})})});var login=function(e,n,r,o){e.collection("users").findOne({username:n},function(e,t){assert.equal(e,null),t?User.comparePassword(r,t.password,function(e,r){if(e)throw e;if(r){var i=jwt.sign({username:n},jwtSecret);o({token:i,user:t})}else o({message:"Invalid password"})}):o({message:"Unknown User"})})},defaultUser=function(e){var n={name:"admin",username:"admin",password:"Daddy@007",type:"admin"};User.createUser(n,function(n,r){e(n,r)})},storage=multer.diskStorage({destination:function(e,n,r){r(null,"./public/img/events/")},filename:function(e,n,r){var o=Date.now();r(null,n.fieldname+"-"+o+"."+n.originalname.split(".")[n.originalname.split(".").length-1])}}),upload=multer({storage:storage}).single("file"),addEvent=function(e,n){var r={event:e.event,description:e.description,imgname:n};maindb(function(e){e.collection("event").save(r).then(function(e){console.log(e)})})};router.post("/upload",function(e,n){upload(e,n,function(r){addEvent(e.body,e.file.filename),r?n.json({error_code:1,err_desc:r}):n.json({error_code:0,err_desc:null})})}),router.post("/remove",function(e,n){maindb(function(n){n.collection("event",function(n,r){r.deleteOne({_id:new ObjectID(e.body.id)})})})}),router.post("/update",function(e,n){upload(e,n,function(r){if(e.file){if(editEvent(e.body,e.file.filename),r)return void n.json({error_code:1,err_desc:r});n.json({error_code:0,err_desc:null})}else{if(editEvent(e.body),r)return void n.json({error_code:1,err_desc:r});n.json({error_code:0,err_desc:null})}})});var editEvent=function(e,n){if(n){var r={_id:new ObjectID(e.id),event:e.event,description:e.description,imgname:n};maindb(function(e){e.collection("event").save(r).then(function(e){})})}else maindb(function(n){n.collection("event").updateOne({_id:new ObjectID(e.id)},{$set:{event:e.event,description:e.description}},function(e,n){})})};module.exports=router;